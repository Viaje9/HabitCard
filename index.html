<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="manifest.json" />
    <title>習慣紀錄小卡</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      /* 拖曳時的樣式 */
      .dragging {
        opacity: 0.5;
      }
      /* 防止手機長按選取文字 */
      .no-select {
        user-select: none;
        -webkit-user-select: none;
      }
    </style>
  </head>
  <body
    class="bg-slate-100 min-h-screen flex items-center justify-center p-4 font-sans text-slate-800"
  >
    <div
      class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200"
    >
      <!-- 標題區 -->
      <div
        class="bg-slate-900 p-6 text-white flex justify-between items-center"
      >
        <div>
          <h1 class="text-xl font-bold tracking-wider">習慣紀錄卡</h1>
          <p class="text-slate-400 text-xs mt-1" id="current-date">
            <!-- 日期由 JS 填入 -->
          </p>
        </div>
        <button
          onclick="resetAllStatus()"
          class="p-2 bg-slate-800 hover:bg-slate-700 rounded-full transition-colors group"
          title="重置今日狀態"
        >
          <i
            data-lucide="rotate-ccw"
            class="w-4 h-4 text-slate-300 group-hover:text-white transition-colors"
          ></i>
        </button>
      </div>

      <!-- 輸入區 -->
      <form
        onsubmit="addHabit(event)"
        class="p-4 border-b border-slate-100 bg-slate-50"
      >
        <div class="flex gap-2">
          <input
            type="text"
            id="habit-input"
            placeholder="輸入新項目..."
            class="flex-1 px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 bg-white"
            autocomplete="off"
          />
          <button
            type="submit"
            class="bg-slate-900 hover:bg-slate-800 text-white p-2 rounded-lg transition-colors"
          >
            <i data-lucide="plus" class="w-6 h-6"></i>
          </button>
        </div>
      </form>

      <!-- 列表區 -->
      <div
        id="habit-list"
        class="p-4 flex flex-col gap-3 min-h-[300px] max-h-[60vh] overflow-y-auto"
      >
        <!-- 列表項目將由 JS 渲染 -->
      </div>

      <!-- 底部圖例 -->
      <div
        class="bg-slate-50 p-3 text-xs text-slate-500 flex justify-center gap-4 border-t border-slate-200 no-select"
      >
        <div class="flex items-center gap-1">
          <i data-lucide="check-circle-2" class="w-3 h-3 text-green-600"></i> 好
        </div>
        <div class="flex items-center gap-1">
          <i data-lucide="minus-circle" class="w-3 h-3 text-yellow-600"></i>
          普通
        </div>
        <div class="flex items-center gap-1">
          <i data-lucide="x-circle" class="w-3 h-3 text-red-600"></i> 壞
        </div>
      </div>
    </div>

    <script>
      // --- 狀態管理 ---
      let habits = [];
      let dragSrcIndex = null;

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 設定日期
        const dateOptions = { year: "numeric", month: "long", day: "numeric" };
        document.getElementById("current-date").textContent =
          new Date().toLocaleDateString("zh-TW", dateOptions);

        // 讀取資料
        loadHabits();

        // 初始渲染
        render();
      });

      // 讀取 localStorage
      function loadHabits() {
        try {
          const saved = localStorage.getItem("my-habit-card");
          habits = saved ? JSON.parse(saved) : [];
        } catch (e) {
          console.error("讀取失敗", e);
          habits = [];
        }
      }

      // 存入 localStorage
      function saveHabits() {
        localStorage.setItem("my-habit-card", JSON.stringify(habits));
      }

      // --- 核心功能 ---

      // 新增習慣
      function addHabit(e) {
        e.preventDefault();
        const input = document.getElementById("habit-input");
        const text = input.value.trim();

        if (!text) return;

        const newHabit = {
          id: Date.now(),
          text: text,
          status: "none", // none, good, neutral, bad
          lastUpdated: new Date().toISOString(),
        };

        habits.push(newHabit);
        saveHabits();
        render();
        input.value = "";
      }

      // 刪除習慣
      function deleteHabit(id) {
        habits = habits.filter((h) => h.id !== id);
        saveHabits();
        render();
      }

      // 循環切換狀態
      function cycleStatus(id) {
        const habit = habits.find((h) => h.id === id);
        if (habit) {
          if (habit.status === "none") habit.status = "good";
          else if (habit.status === "good") habit.status = "neutral";
          else if (habit.status === "neutral") habit.status = "bad";
          else if (habit.status === "bad") habit.status = "none";

          habit.lastUpdated = new Date().toISOString();
          saveHabits();
          render();
        }
      }

      // 重置所有狀態
      function resetAllStatus() {
        if (habits.length > 0 && confirm("確定要重置所有項目的狀態嗎？")) {
          habits.forEach((h) => (h.status = "none"));
          saveHabits();
          render();
        }
      }

      // 取得樣式設定
      function getStatusConfig(status) {
        switch (status) {
          case "good":
            return {
              bg: "bg-green-100",
              border: "border-green-300",
              icon: "check-circle-2",
              iconColor: "text-green-600",
              label: "好習慣",
            };
          case "bad":
            return {
              bg: "bg-red-100",
              border: "border-red-300",
              icon: "x-circle",
              iconColor: "text-red-600",
              label: "壞習慣",
            };
          case "neutral":
            return {
              bg: "bg-yellow-50",
              border: "border-yellow-300",
              icon: "minus-circle",
              iconColor: "text-yellow-600",
              label: "不好不壞",
            };
          default:
            return {
              bg: "bg-white",
              border: "border-slate-200",
              icon: "circle", // 使用空圓圈或自定義
              iconColor: "text-slate-300",
              label: "點擊標記",
            };
        }
      }

      // --- 拖拉功能 (Drag and Drop) ---

      function handleDragStart(e) {
        const index = e.target.closest(".habit-row").dataset.index;
        dragSrcIndex = parseInt(index);

        // 設定透明度
        e.target.closest(".habit-row").classList.add("opacity-50");

        // 必須設定 dataTransfer 才能在 Firefox 運作
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", e.target.innerHTML);
      }

      function handleDragEnter(e) {
        // 找到目前滑鼠下方的 row
        const targetRow = e.target.closest(".habit-row");
        if (!targetRow) return;

        const targetIndex = parseInt(targetRow.dataset.index);

        // 如果目標位置不同，進行陣列交換並重新渲染
        if (dragSrcIndex !== null && dragSrcIndex !== targetIndex) {
          // 交換陣列元素
          const temp = habits[dragSrcIndex];
          habits.splice(dragSrcIndex, 1);
          habits.splice(targetIndex, 0, temp);

          // 更新當前索引
          dragSrcIndex = targetIndex;

          // 儲存並重新渲染 (視覺上會即時交換)
          saveHabits();
          render();

          // 重新渲染後，需要重新抓取當前的 row 加上 opacity 樣式
          // 因為 DOM 已經重建了
          const newRows = document.querySelectorAll(".habit-row");
          if (newRows[dragSrcIndex]) {
            newRows[dragSrcIndex].classList.add("opacity-50");
          }
        }
      }

      function handleDragEnd(e) {
        // 移除所有 opacity 樣式
        document.querySelectorAll(".habit-row").forEach((row) => {
          row.classList.remove("opacity-50");
        });
        dragSrcIndex = null;
      }

      // --- 渲染畫面 ---
      function render() {
        const listContainer = document.getElementById("habit-list");

        if (habits.length === 0) {
          listContainer.innerHTML = `
                    <div class="text-center text-slate-400 py-10 flex flex-col items-center select-none">
                        <i data-lucide="save" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p>還沒有紀錄項目</p>
                        <p class="text-xs mt-1">新增一個習慣開始追蹤吧</p>
                    </div>
                `;
          lucide.createIcons();
          return;
        }

        let html = "";
        habits.forEach((habit, index) => {
          const config = getStatusConfig(habit.status);

          // 特殊處理：如果是 'none' 狀態，我們手動畫一個圓圈，而不是用 Lucide icon，以符合 React 版本外觀
          let iconHtml = "";
          if (habit.status === "none") {
            iconHtml = `<div class="w-6 h-6 rounded-full border-2 border-slate-300"></div>`;
          } else {
            iconHtml = `<i data-lucide="${config.icon}" class="w-6 h-6 ${config.iconColor}"></i>`;
          }

          html += `
                    <div 
                        class="habit-row relative group flex items-center gap-2 p-3 rounded-xl border-l-4 transition-all duration-200 shadow-sm hover:shadow-md ${
                          config.bg
                        } ${config.border}"
                        data-index="${index}"
                        ondragenter="handleDragEnter(event)"
                        ondragover="event.preventDefault()" 
                    >
                        <!-- 拖拉把手: 只有這裡有 draggable="true" -->
                        <div 
                            draggable="true"
                            ondragstart="handleDragStart(event)"
                            ondragend="handleDragEnd(event)"
                            class="cursor-grab active:cursor-grabbing text-slate-400 hover:text-slate-600 p-1 hover:bg-black/5 rounded"
                        >
                            <i data-lucide="grip-vertical" class="w-5 h-5 pointer-events-none"></i>
                        </div>

                        <!-- 點擊切換區 -->
                        <button 
                            onclick="cycleStatus(${habit.id})"
                            class="flex-1 flex items-center gap-3 text-left focus:outline-none pl-1"
                        >
                            <div class="flex-shrink-0 transition-transform active:scale-90">
                                ${iconHtml}
                            </div>
                            <div class="flex flex-col">
                                <span class="font-medium text-lg ${
                                  habit.status === "none"
                                    ? "text-slate-700"
                                    : "text-slate-900"
                                }">
                                    ${habit.text}
                                </span>
                                <span class="text-xs text-slate-500 font-medium">
                                    ${config.label}
                                </span>
                            </div>
                        </button>

                        <!-- 刪除按鈕 -->
                        <button
                            onclick="deleteHabit(${habit.id})"
                            class="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full"
                            title="刪除"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
        });

        listContainer.innerHTML = html;

        // 重新渲染圖示
        lucide.createIcons();
      }
    </script>
  </body>
</html>
